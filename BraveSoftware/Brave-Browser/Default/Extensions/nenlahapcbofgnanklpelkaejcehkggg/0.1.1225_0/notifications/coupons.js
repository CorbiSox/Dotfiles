import{a as Ae,b as Ve}from"../chunks/chunk-NJBVQLS2.js";import{a as ne}from"../chunks/chunk-NNM7UN3I.js";import{a as $,b as ke,g as be,h as Ie}from"../chunks/chunk-JSBRN6X5.js";import"../chunks/chunk-3NOLLE5N.js";import"../chunks/chunk-DT7PBS4M.js";import"../chunks/chunk-BNNGPYUP.js";import{a as De}from"../chunks/chunk-OFJO7COX.js";import{a as re}from"../chunks/chunk-RFNJKUZW.js";import{a as Re}from"../chunks/chunk-G4GLYCCY.js";import{a as se}from"../chunks/chunk-RNDVJQN2.js";import{G as ye,I as ve,a as le,f as ue,i as we,j as Te,l as Se,m as Ce}from"../chunks/chunk-WVZLHOFL.js";import"../chunks/chunk-A5YKHYT6.js";import"../chunks/chunk-D3PBAGDZ.js";import{a as Qe,b as J}from"../chunks/chunk-3XIOB4EC.js";import{A as de,B as he,C as _e,E as x,c as O,d as U,e as me,i as fe}from"../chunks/chunk-D2E2HG2W.js";import{b as ce,e as pe,h as ge}from"../chunks/chunk-A36NQ4WF.js";import"../chunks/chunk-TSZP6UXS.js";import{b as B}from"../chunks/chunk-VZ75JTZE.js";import"../chunks/chunk-IOEYPKEV.js";import"../chunks/chunk-NYGFFQMG.js";import"../chunks/chunk-3MQH4JJT.js";import{a as z}from"../chunks/chunk-NZY4JV6E.js";import"../chunks/chunk-4GT6T77M.js";import{a as Z,b as Ke}from"../chunks/chunk-N3RCD34N.js";import"../chunks/chunk-4GJAJKDK.js";import"../chunks/chunk-3R2PURR4.js";import"../chunks/chunk-JDV5FZKX.js";import"../chunks/chunk-BCG2KUGW.js";import{q as S}from"../chunks/chunk-E4QNY2PC.js";import"../chunks/chunk-ZIQ6U6YW.js";import"../chunks/chunk-B7GBMFFD.js";import"../chunks/chunk-AKTW5CPL.js";import"../chunks/chunk-LLA7RVSB.js";import"../chunks/chunk-Z6PVZUDE.js";import{a as ie}from"../chunks/chunk-FEK2HJKI.js";import"../chunks/chunk-NJ63VSGO.js";import{b as ae}from"../chunks/chunk-OTRTIFBS.js";import"../chunks/chunk-MFYKHTND.js";import{J as W,c as oe}from"../chunks/chunk-3I3QPOUL.js";import"../chunks/chunk-O4TFJKJQ.js";import{c as o,d as N,e as te,f as I,g as G,h as l,q as v,u as T}from"../chunks/chunk-4SRFE46V.js";import"../chunks/chunk-RXMLGJMT.js";import"../chunks/chunk-IJQWISPG.js";import"../chunks/chunk-HY2GWXPO.js";import{b as ee,c as Ye}from"../chunks/chunk-LC5XJ32R.js";import"../chunks/chunk-6LTHT6DZ.js";import"../chunks/chunk-XSKOAVIS.js";import{d as Q,j as X,p as Be,q as $e}from"../chunks/chunk-52XVUBCW.js";import{b as E,c as je}from"../chunks/chunk-42JNP4CL.js";import{n as He}from"../chunks/chunk-SOWOQI5E.js";import"../chunks/chunk-YCRAP75I.js";import"../chunks/chunk-JAUVA5AU.js";import{e as V}from"../chunks/chunk-3GYLW4KZ.js";var Ee=V(He());Be();var t=V($e());var q=V(Qe());je();Ye();Ke();var Ne=e=>v("getAutoCoupTestList",e);var Oe=e=>v("getPartnerGroupsList",e);var xe=e=>v("getRooVsTiggerDomains",e);var Pe=()=>v("hasDeferredCouponRewards");var j=V(oe());window.__wb_timing.couponsRequireAt=performance.now();var Xe=new Set(["etsy.com","amazon.com"]),L=!1,P=!1,Ze=t.default.throttle(ne,2e3),et=()=>{setTimeout(()=>{let e={currentLocation:t.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])},s=t.default.extend({},window.__wb_timing,e);T("track","pageTimingMetrics",s)},5e3)};function tt(){return Ee.default.all([se(),z(),ge(),re(),Pe(),Ve(),Oe(),xe(),Ne()]).spread((e,s,c,i,n,m,g,p,f)=>{Re(e),o.merge({siteAPIData:s}),o.merge({cashback:c}),o.set("lifetimeSavings",i),o.set(["couponView","hasDeferredCouponRewards"],n),o.set("sameTabRedirectDomains",m),o.set(["couponView","partnerGroupsList"],g),o.set(["couponView","rooVsTiggerDomains"],p),o.set(["couponView","autoCoupTestList"],f)})}var ot=[{domain:"etsy.com"},{domain:"amazon.com",condition:e=>{let s=t.default.get(e,"pageType")==="checkoutPage",c=t.default.get(e,"pageData.meta"),i=c?c.coupon_input_present:!1;return s&&i}}];function Le(e,s){return!!t.default.find(ot,i=>i.domain===e&&(i.condition?i.condition(s):!0))}async function at(){E("COUPONS INIT");let[e,s,c]=await Promise.all([De("24_hr_throttle_all"),O("emailCreateAccount"),O("affiliateRedirect"),tt()]);if(e)return;let i=I();if(et(),navigator.userAgent.indexOf("Firefox")>-1&&i.match(/eyebuydirect\.com/))return!1;let n=o.get("cashback");if(s&&JSON.parse(s)?.shouldLoadNotification&&(await U("emailCreateAccount"),fe(t.default.get(n,"reward",null))),!o.get(["couponView","partnerGroupsList"])?.groupA?.includes(i)&&l("ac_elasticity_3")){let r=o.get("deweyResult");r?x(r):B.emitter.on("result",a=>{x(a)});return}if(c){let r=JSON.parse(c);if(o.set("affiliateRedirect",r),pe()){let a=window.location.href,h=o.get("pageViewId");Ae({resolvedUrl:a,domain:i,pageViewId:h})}}o.set("couponsVisible",!1);let g=o.get("siteAPIData"),p=await st(g),f=t.default.get(g,"siteData.coupons.tld")==="ebay.com"&&t.default.get(g,"siteData.coupons.coupons.length");me()||(n&&!n.postCoupons&&!f?N({active:!0,cashback:n,fromCoupons:!0}):N({active:!0}));let u;try{u=JSON.parse(sessionStorage.getItem("ogPageData")),u&&u.expires<Z()&&(sessionStorage.removeItem("ogPageData"),u=null)}catch{}async function D(r){if(Ze(i,r),await rt(r),r.callSource==="internal"&&r.pageData)try{let a=JSON.parse(sessionStorage.getItem("cartTotalAfterSavings"));if(sessionStorage.removeItem("cartTotalAfterSavings"),!Number.isNaN(a.value)){let h=Date.now()-a.time;r.pageData?.order?.total>a.value&&h<2e3&&T("track","extensionError",{type:"coupon_error"})}}catch{}if(r.callSource==="coupons_start"&&r.pageData)sessionStorage.setItem("ogPageData",JSON.stringify({...r.pageData,expires:X(Q(new Date,3))}));else if(r.callSource==="coupons_end"){let a=o.select("couponView").get("resultTemp");a||(a=o.select("couponView").get("result"),a.pageReload=void 0);try{u=JSON.parse(sessionStorage.getItem("ogPageData"))}catch{}sessionStorage.removeItem("ogPageData");let h=t.default.get(u,"order.total");if(a.deweyOriginalTotal=h,a.savings>0){t.default.get(r,"pageData.products.length")>1?r.pageData.products=t.default.map(r.pageData.products,(w,M)=>(t.default.has(w,"list_price")&&t.default.has(u,`products[${M}].list_price`)&&u.products[M].list_price-w.list_price&&(w.coupon_savings=u.products[M].list_price-w.list_price),w.coupon_applied=a.bestCoupon.code,w)):t.default.get(r,"pageData.products.length")===1&&(r.pageData.products[0].coupon_savings=a.savings,r.pageData.products[0].coupon_applied=a.bestCoupon.code);let A=r.pageData?.order?.total;A>0&&sessionStorage.setItem("cartTotalAfterSavings",JSON.stringify({value:A,time:Date.now()}))}let b=I(),_=o.get("couponsConfig");if(_&&_.pageWasReloaded){_.result=a;let A=o.get("couponView"),w=t.default.get(A,"resultTemp.allCoupons",[]);Xe.has(b)&&w.length>0&&(_.coupons=t.default.cloneDeep(w)),R(_,n)}else o.select("couponView").set("result",a);a&&a.couponScriptType==="roo"&&T("track","rooActionTiming",{triggerType:a.automaticCouponsRun?"auto":a.autoFallback?"auto_fallback":a.isSiteHub?"site_hub":null,couponRunId:a.couponRunId,aggApplyCodeTime:a.aggApplyCodeTime,aggGetTotalTime:a.aggGetTotalTime,aggRemovePreviousTime:a.aggRemovePreviousTime,aggWaitForReloadTime:a.aggWaitForReloadTime,initialActionTime:a.initialActionTime,currentLocation:t.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])});let{automaticCouponsRun:Ge,autoFallback:Je,isSiteHub:Ue,manuallyActivatedAutoRun:qe,manuallyActivatedFallback:Me}=a,We=le({automaticCouponsRun:Ge||qe,autoFallback:Je,isSiteHub:Ue,manuallyActivatedFallback:Me});o.select("couponView").set("manuallyActivatedAutoRun",a.manuallyActivatedAutoRun);let ze=localStorage.getItem("__wb_redirecting")&&a.manuallyActivatedAutoRun,Y=o.get("affiliateRedirect");a.manuallyActivatedAutoRun&&Y&&(a.couponRunId=t.default.get(Y,"couponRunId",a.couponRunId)),ze||(pt({couponResult:a,triggerType:We,siteAPIData:g}),T("track","deweyResult",t.default.assign(r,{url:window.location.href})))}else if(u&&t.default.get(r,"pageType")&&!P)P=!0,p();else if(Le(i,r)&&!L){if(t.default.get(r,"pageData"))if(i==="amazon.com")await Fe(r,p,n);else{let a=await p();if(a){L=!0;let h=await S({message:"getClassifierCodes",domain:i,pageData:r.pageData});if(h){let b=d({siteAPIData:g,classifierCoupons:h,rankedCoupons:a.coupons});a.coupons=b}R(a,n)}}}else if(P&&l("ext_coupons_skip_cashback_fallback")&&g?.siteData?.coupons?.type==="roo"&&(r.pageType==="cartPage"||r.pageType==="checkoutPage")&&!o.get(["couponView","rooIsCheckingForCouponPage"])&&!o.get(["couponView","rooIsCouponPage"])){let a=await p();a&&R(a,n)}else if(!l("ext_coupons_skip_cashback_fallback")&&!o.get("cashbackVisible")&&!t.default.get(n,"postCoupons")){let a=Ce()?3e3:1e3;setTimeout(()=>{if(!o.get("couponsVisible")){let h=o.get("deweyResult");x(h)}},a)}}let F=await O("rooReloading"),C=o.get("deweyResult");C&&!F&&D(C),F&&await U("rooReloading"),B.emitter.on("result",D);function d({siteAPIData:r,classifierCoupons:a,rankedCoupons:h}={}){let b=t.default.get(r,"siteData.coupons.count"),_=t.default.concat(a,h);return _=t.default.uniqBy(_,"code"),_.slice(0,b)}let y=Le(i,C),k;!y&&!P&&(P=!0,k=await p());let K=t.default.get(C,"pageData");if(y){if(i==="amazon.com")await Fe(C,p,n);else if(K&&!L){let r=await p();if(r){L=!0;let a=await S({message:"getClassifierCodes",domain:i,pageData:K});a&&(r.coupons=a),R(r,n)}}}k&&!k.pageWasReloaded&&R(k,n)}async function R(e,s){E("PREPARE COUPONS",{coupons:e,cashback:s});let{standDown:c}=e,i=I();o.merge("couponView",e);let n=o.get("cashbackView")||s;o.set("cashbackView",n);let m={cssUrl:"coupons.css",disableDelay:!0};if(n&&t.default.get(n,"user.compInactivated")&&_e()&&!o.get("cashbackReactivateVisible")&&!o.get("throttleCreditsReactivation")){o.set(["warnAboutStandDown"],!0),o.set("cashbackReactivateVisible",!0),W({...m,appName:"reactivate",app:(0,j.jsx)(de,{})});return}let p=o.get("affiliateRedirect");if(sessionStorage.getItem("__wb_same_tab_auto")||sessionStorage.getItem("__r_reload_auto")){let d;if(p&&({manuallyActivatedAutoRun:d}=p,d&&o.select("couponView").set("manuallyActivatedAutoRun",d)),sessionStorage.getItem("__wb_same_tab_auto")){let y=JSON.parse(sessionStorage.getItem("__wb_same_tab_auto"));d=t.default.get(y,"manuallyActivatedAutoRun")}if(sessionStorage.getItem("__r_reload_auto")){let y=JSON.parse(sessionStorage.getItem("__r_reload_auto"));d=t.default.get(y,"manuallyActivatedAutoRun")}d||await S({domain:i,message:"endThrottle"})}try{let d=await O("deferredPinTab");d&&(ce(JSON.parse(d)),U("deferredPinTab"))}catch{}let f=Se(),u=i;te(i)&&o.get("deweyResult","pageType")==="checkoutPage"&&(u="amazon.com_checkout");let D=await S({domain:u,message:"isThrottled",isAutoCoup:f});if(f&&await S({domain:u,message:"isAutoCoupThrottled",isAutoCoup:f})){if(o.get("affiliateRedirect")){let y=sessionStorage.getItem("__wb_clickId"),k=localStorage.getItem("__wb_redirecting");if(y&&!k){D||(sessionStorage.removeItem("__wb_clickId"),Te());return}}o.select("couponView").set("autoCoupThrottled",!0)}let F=!!o.get(["events","hasSeenCouponsThrottleToolTip"]),C=D&&!F&&!e.pageWasReloaded;if(o.select("couponView").set("showThrottleToolTip",C),D&&!e.pageWasReloaded){if(o.set("couponsThrottled",!0),!C){N({active:!0,textOverride:`${t.default.get(e,"coupons.length","")}C`}),l("ext_coupons_skip_cashback_fallback")&&!l("ext_coupons_skip_cashback_when_throttled")&&x(o.get("deweyResult"));return}}else if(c){o.set("couponsThrottled",!0),he();return}o.get(["couponView","standDownOverride"])&&N({active:!0,textOverride:`${t.default.get(e,"coupons.length","")}C`}),i==="groupon.com"&&T("track","foundCouponsEnd",{pageViewId:o.get("pageViewId")}),o.get("couponsVisible")||(o.set("couponsVisible",!0),W({...m,appName:be,app:(0,j.jsx)(Ie,{})}))}function H(e,s){let c;s==="Shopify"&&(c=(0,q.getShopifyPath)()),T("track","platformIdentified",{platform:s,currentLocation:t.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"]),shopifyPath:c})}async function it(){let e=window.location.hostname,s=I(),c;e.includes("shop.app")&&(c=l("ext_separate_domain_platform")?o.get("platformDomain"):await J(s));let i=o.get("platform")==="Shopify"||c;if(c||(c=e),i){let n=await S({message:"makeRequest",reqInfo:{method:"GET",url:`https://${c}/cart.json`,headers:{Accept:"*/*"}}});if(n?.items?.length>0)return nt(n)}}function nt(e){let s=t.default.map(e.items,c=>t.default.pick(c,["id","product_id","sku","url","discounts","discounted_price","original_price","image","title","variant_title"]));return JSON.stringify({cartLevelDiscountApplications:e?.cart_level_discount_applications,cartItems:s,originalTotal:e?.original_total_price,totalDiscount:e?.total_discount,totalPrice:e?.total_price})}async function rt(e){let s=I(),c=l("ext_separate_domain_platform")?o.get("platformDomain"):await J(s);if((l("ext_separate_domain_platform")?o.get("platform")==="Shopify":c)&&e&&e.pageType==="checkoutPage"){let n=document.querySelectorAll(".notice.notice--warning .notice__text"),m=t.default.find(n,g=>g.offsetHeight>0);if(m){let g=m.querySelector("strong").innerText.trim();T("track","shopifyInvalidCouponDetected",{domain:s,coupon:g})}}}async function st(e){let s=t.default.get(e,"tld");if(ke()){let m=l("roo_coup_24_q_3_test")&&"roo"||l("tigger_coup_24_q_3_test")&&"asyncTigger";m&&t.default.assign(e.siteData.coupons,{type:m})}let c=await(0,q.getPlatform)({hasFeature:l,desktop:!0});c&&(o.set(["platform"],c),H(s,c)),G(s);let i=l("ext_separate_domain_platform")?o.get("platformDomain"):await J(s),n=l("ext_separate_domain_platform")?o.get("platform")==="Shopify":i;if(i&&(l("ext_separate_domain_platform")?H(s,o.get("platform")):H(s,"Shopify")),t.default.get(e,"siteData.coupons.ignoreSite"))return t.default.noop;if(t.default.get(e,"siteData.coupons.type")==="eeyore"&&t.default.get(e,"siteData.coupons.coupons.length")>0)return t.default.get(e,"siteData.coupons.identifiers")?ve:t.default.noop;if(t.default.get(e,"siteData.coupons.type")==="tigger"&&(i||await ue.isTiggerSite(s,c))){if(i){if(G(i),i!==s){let g=await S({message:"makeRequest",reqInfo:{method:"GET",url:`${ae}/site/${i}`,headers:{"Content-Type":"application/json"}}}),p=t.default.get(g,"siteData.coupons"),f=t.default.get(g,"siteData");t.default.assign(e,{tld:p.tld,cashback:f?.cashback,merchantPage:f?.merchantPage,pageTypesV2:f?.pageTypesV2}),G(p.tld),t.default.assign(e.siteData.coupons,{coupons:p.items||[],ignoreSite:t.default.isUndefined(p.ignoreSite)?!0:p.ignoreSite,ignoreAffiliate:t.default.isUndefined(p.ignoreAffiliate)?!0:p.ignoreAffiliate,tld:p.tld}),o.merge({siteAPIData:e})}n&&(e.siteData.coupons.shopify=!0,e.siteData.appliedCodeSelector=".applied-reduction-code__information"),await z(t.default.assign(e,{domain:i,setSite:!0}))}return!!(l("shopify_async_tigger")&&n)?$:ye}else{if(t.default.get(e,"siteData.coupons.type")==="roo")return we.initCoupons;if(t.default.get(e,"siteData.coupons.type")==="asyncTigger")return t.default.get(e,"siteData.coupons.identifiers")?$:t.default.noop}return t.default.noop}async function Fe(e,s,c){if(e){let i=await s({experience:"checkout"});if(!l("amz_class_on"))return;L=!0;let n=await S({message:"getClassifierCodes",domain:"amazon.com",pageData:e.pageData,pageViewId:o.get("pageViewId")});n&&(i.coupons=n),n&&n.length>=1&&(i.couponCount=n.length,R(i,c))}}function ct(e){let i=!1,n=e||0;return n=parseInt(n),isNaN(n)&&(i=!0,n=0),n>1e8?(i=!0,n=1e8):n<-1e8&&(i=!0,n=-1e8),{cleanedSavings:n,wasCleaned:i}}E(document.readyState);async function pt({couponResult:e,triggerType:s,siteAPIData:c}={}){let{cleanedSavings:i,wasCleaned:n}=ct(e.savings),m=new Date().getTime()-t.default.get(e,"startTime")||null,g=ie(i,{noDollarSign:!0})??"0",p=t.default.round(parseFloat(g),2);await chrome.storage.local.set({lastCouponSavings:p});let f=await it();T("track","tryCouponsResult",{triggerType:s,couponScriptType:e.couponScriptType,clickId:e.clickId,redirectId:ee(e.clickId),couponRunId:e.couponRunId,cashback:e.cashback,deweyOriginalTotal:e.deweyOriginalTotal,originalTotal:e.originalTotal,originalTotalV2:e.originalTotalV2,baseTotal:e.baseTotal,finalTotal:e.finalTotal,savingsOld:e.savings||0,savings:i,savingsCurrency:c?.siteData?.merchantPage?.currency,savingsWasCleaned:n,shopifyLoggedIn:e.shopLoggedIn,couponReloadSkipped:e.couponReloadSkipped,errored:e.errored,runTime:e.runTime,runTimeV2:m,totalCouponsTested:t.default.get(e,"coupons.length"),coupons:t.default.get(e,"coupons"),originalCoupons:e.originalCoupons,preappliedCodes:e.preappliedCodes,bestCoupon:t.default.get(e,"bestCoupon.code"),platform:e.platform,cartData:f,currentLocation:t.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])})}at();
